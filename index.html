<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SSC CGL Mock — Full Offline</title>
<style>
:root{
  --ssc-blue:#004b8d;
  --muted:#6b7280;
  --bg:#f3f6fb;
  --not-visited:#2f80ed;
  --answered:#16a34a;
  --current:#f59e0b;
  --review:#7c3aed;
  --danger:#ef4444;
  --card:#fff;
}
*{box-sizing:border-box;font-family:Inter, Arial, Helvetica, sans-serif}
body{margin:0;background:var(--bg);color:#0b1220}
.app{max-width:1200px;margin:18px auto;background:var(--card);border-radius:8px;overflow:hidden;box-shadow:0 8px 26px rgba(2,6,23,0.08)}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:#fff;border-bottom:6px solid var(--ssc-blue)}
.brand{display:flex;align-items:center;gap:12px}
.brand img{height:44px}
.title{font-weight:700;font-size:18px;color:var(--ssc-blue)}
.timer{font-weight:800;color:#111;font-size:18px}
.page{display:none;padding:20px}
.page.active{display:block}
.card{max-width:900px;margin:12px auto;background:#fff;padding:18px;border-radius:8px;border:1px solid #e6eef6}
label{display:block;margin-top:8px;font-weight:600;color:#0b1220}
input[type="text"], select, textarea{width:100%;padding:10px;font-size:15px;border:1px solid #dbe7fb;border-radius:6px;margin-top:6px}
button.btn{display:inline-block;padding:10px 16px;background:var(--ssc-blue);color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer;margin-top:12px}
button.btn.secondary{background:#fff;color:var(--ssc-blue);border:1px solid #cfe0fb}
.note{margin-top:12px;color:#0b1220;font-size:14px}

/* Quiz layout */
.quiz-top{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:#fff;border-bottom:1px solid #eef6ff}
.quiz-main{display:flex;gap:12px;padding:18px}
.left-col{width:320px;border-right:1px solid #f0f5fb;padding-right:14px}
.right-col{flex:1;padding-left:14px}
.parts{display:flex;gap:8px;margin-bottom:12px}
.part-btn{flex:1;padding:8px;border-radius:6px;border:1px solid #dbe7fb;background:#fff;cursor:pointer;font-weight:700}
.part-btn.active{background:var(--ssc-blue);color:#fff;border-color:transparent}
.section-title{margin:10px 0;color:var(--muted);font-weight:700}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.qbtn{padding:10px;text-align:center;border-radius:6px;color:#fff;font-weight:800;border:none;cursor:pointer}
.q-notvisited{background:var(--not-visited)}
.q-current{background:var(--current)}
.q-answered{background:var(--answered)}
.q-review{background:var(--review)}
.analysis{margin-top:12px;padding:10px;background:#fcfdff;border-radius:6px;border:1px solid #eef6ff}
.clear{margin-top:12px;padding:10px;background:var(--danger);color:#fff;border:none;border-radius:6px;cursor:pointer;width:100%}

.qheader{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.qtext{font-weight:700;font-size:16px;margin-bottom:12px}
.options{display:flex;flex-direction:column;gap:10px}
.option{display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;border:1px solid #eef6ff;cursor:pointer;background:#fff}
.controls{display:flex;gap:8px}
.btn-primary{background:var(--not-visited);color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;font-weight:700}
.btn-outline{background:#fff;border:1px solid #dbe7fb;padding:10px 12px;border-radius:6px;cursor:pointer}
.submit-row{display:flex;justify-content:flex-end;margin-top:12px}
.btn-submit{background:#059669;color:#fff;padding:10px 14px;border-radius:6px;border:none;cursor:pointer;font-weight:700}

/* controls */
.top-controls{display:flex;gap:8px;align-items:center}
.palette-controls{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.watermark{position:fixed;opacity:0.06;font-size:80px;color:#000;transform:rotate(-30deg);left:50%;top:50%;pointer-events:none;white-space:nowrap;user-select:none}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:2000}
.modal .box{background:#fff;padding:18px;border-radius:8px;min-width:320px}
.admin{display:none;padding:12px;border-top:1px solid #eef6ff;background:#fff}
.admin-list-item{padding:8px;border-bottom:1px solid #eef6ff;background:#fff;margin-bottom:6px;border-radius:6px;cursor:grab}
.timer.warn{color:var(--danger);animation:pulse 1s infinite;font-weight:900}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
@media (max-width:980px){.quiz-main{flex-direction:column}.left-col{width:100%;border-right:none;border-bottom:1px solid #f0f5fb;padding-bottom:12px}.right-col{padding-left:0}}
</style>
</head>
<body>
<div class="watermark" id="watermark" style="display:none"></div>
<div class="app" role="application" aria-label="SSC Mock Test App">

  <div class="topbar">
    <div class="brand">
      <!-- Embedded SSC-like small SVG logo in base64 (simple) -->
      <img alt="SSC" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNDQiIHZpZXdCb3g9IjAgMCA4MCA0NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjQ0IiByeD0iOCIgc3R5bGU9ImZpbGw6I0ZGMzI0RTsiLz4KPHRleHQgeD0iMTAiIHk9IjI4IiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgZm9udC1mYW1pbHk9IkFyaWFsLCBIZWx2ZXRpY2EsIHNhbnMtc2VyaWYiPkNTQzwvdGV4dD4KPC9zdmc+" />
      <div><div class="title">SSC</div><div style="font-size:12px;color:var(--muted)">Offline Mock</div></div>
    </div>

    <div class="top-controls">
      <div id="topTimer" class="timer">01:00:00</div>
      <button id="darkToggle" class="btn secondary" title="Toggle Dark Mode">Dark</button>
      <button id="adminBtn" class="btn secondary" title="Admin (password protected)">Admin</button>
    </div>
  </div>

  <!-- Page 1: Login -->
  <div id="page1" class="page active">
    <div class="card">
      <h2 style="margin:0;color:var(--ssc-blue)">Candidate Information</h2>
      <p class="note">Enter Roll Number and Candidate Name to proceed</p>
      <label>Roll Number</label>
      <input id="rollInput" type="text" placeholder="Enter roll number" autocomplete="off">
      <label>Candidate Name</label>
      <input id="nameInput" type="text" placeholder="Enter candidate name" autocomplete="off">
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="continueBtn" class="btn">Continue</button>
        <button id="adminQuick" class="btn secondary" style="margin-left:auto">Admin</button>
      </div>
    </div>
  </div>

  <!-- Page 2: Language -->
  <div id="page2" class="page">
    <div class="card">
      <h2 style="margin:0;color:var(--ssc-blue)">Select Language</h2>
      <p class="note">Choose the language for the test</p>
      <label>Language</label>
      <select id="langSelect"><option value="english">English</option><option value="hindi">हिन्दी</option></select>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="startBtn" class="btn">Start Test</button>
        <button id="backBtn" class="btn secondary">Back</button>
      </div>
    </div>
  </div>

  <!-- Page 3: Quiz -->
  <div id="page3" class="page">
    <div class="quiz-top">
      <div style="display:flex;gap:16px;align-items:center">
        <div style="font-weight:800;color:#0b1220">SSC CGL MOCK TEST</div>
        <div id="candidateInfo" style="font-size:13px;color:var(--muted)">Roll: - | Name: - | Lang: -</div>
      </div>
      <div><div id="globalTimer" class="timer">01:00:00</div></div>
    </div>

    <div class="quiz-main">
      <aside class="left-col" aria-label="Question palette">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="parts">
            <button class="part-btn active" data-part="A">PART-A</button>
            <button class="part-btn" data-part="B">PART-B</button>
            <button class="part-btn" data-part="C">PART-C</button>
            <button class="part-btn" data-part="D">PART-D</button>
          </div>
        </div>

        <div style="margin-top:8px" class="palette-controls">
          <button class="btn secondary" data-filter="all">All</button>
          <button class="btn secondary" data-filter="answered">Answered</button>
          <button class="btn secondary" data-filter="notAnswered">Not Answered</button>
          <button class="btn secondary" data-filter="review">Marked</button>
        </div>

        <div class="section-title">Section: <span id="curPart">A</span></div>
        <div class="grid" id="qGrid"></div>

        <div class="analysis">
          <div><strong>PART-<span id="partLabel">A</span> Analysis</strong></div>
          <div>Answered: <span id="ansCount">0</span></div>
          <div>Not Answered: <span id="notAnsCount">25</span></div>
          <div>Section time: <span id="sectionTime">0</span> sec</div>
        </div>

        <button id="clearBtn" class="clear">Clear Response</button>
      </aside>

      <section class="right-col">
        <div class="qheader">
          <div>Question : <span id="qLabel">A-1</span></div>
          <div class="controls">
            <button id="markBtn" class="btn-outline">Mark for Review & Next</button>
            <button id="saveBtn" class="btn-primary">Save & Next</button>
          </div>
        </div>

        <div id="qArea"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <button id="reviewBtn" class="btn secondary">Review Summary</button>
          <div><button id="submitBtn" class="btn-submit">Submit & Export CSV</button></div>
        </div>
      </section>
    </div>
  </div>

  <!-- Admin panel (hidden) -->
  <div id="adminPanel" class="admin">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Admin Panel</strong></div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="newPass" type="password" placeholder="New pass (leave blank to keep)" style="padding:8px;border-radius:6px;border:1px solid #dbe7fb" />
        <button id="setPassBtn" class="btn secondary">Set Pass</button>
        <button id="closeAdmin" class="btn secondary">Close Admin</button>
      </div>
    </div>
    <div style="display:flex;gap:12px;margin-top:12px">
      <div style="width:360px">
        <label>Language</label>
        <select id="adminLang"><option value="english">English</option><option value="hindi">हिन्दी</option></select>
        <label>Part</label>
        <select id="adminPart"><option>A</option><option>B</option><option>C</option><option>D</option></select>
        <label>Search</label>
        <input id="adminSearch" placeholder="search text or option" />
        <label style="margin-top:8px">Question Text</label>
        <textarea id="adminQText" rows="3"></textarea>
        <label>Options (one per line)</label>
        <textarea id="adminOptions" rows="4" placeholder="Option A\nOption B\nOption C\nOption D"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="adminAdd" class="btn">Add</button>
          <button id="adminUpdate" class="btn secondary">Update</button>
          <button id="adminReset" class="btn secondary">Reset</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="exportBank" class="btn">Export JSON</button>
          <button id="importBank" class="btn secondary">Import JSON</button>
          <input id="importFile" type="file" accept=".json" style="display:none" />
        </div>
        <div style="margin-top:10px">
          <button id="viewAttempts" class="btn secondary">View Past Attempts</button>
          <button id="exportAttempts" class="btn">Export Attempts CSV</button>
        </div>
      </div>

      <div style="flex:1">
        <label>Questions (drag to reorder)</label>
        <div id="adminList" style="max-height:520px;overflow:auto;border:1px solid #eef6ff;padding:8px"></div>
      </div>
    </div>
  </div>

</div>

<div id="modal" class="modal"><div class="box" id="modalBox"></div></div>

<script>
/* ======== Configuration & Keys ======== */
const SECTIONS = ['A','B','C','D'];
const Q_PER_SECTION = 25;
const START_SECONDS = 60*60;
const WARNING_SECONDS = 5*60;
const KEY_BANK = 'ssc_bank_final_v1';
const KEY_STATE = 'ssc_state_final_v1';
const KEY_ATTEMPTS = 'ssc_attempts_final_v1';
const ADMIN_PASS = 'chotimoti'; // admin password as requested

/* ======== Utilities ======== */
const $ = id => document.getElementById(id);
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function downloadFile(content, name, type){ const blob = new Blob([content], { type }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },1500); }
function loadJSON(key, fallback){ try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch(e){ return fallback; } }
function saveJSON(key,obj){ localStorage.setItem(key, JSON.stringify(obj)); }

/* ======== Default question bank (100 English + 100 Hindi) ======== */
function defaultBank(){
  const bank = { english:{}, hindi:{} };
  SECTIONS.forEach((part, pi) => {
    bank.english[part]=[]; bank.hindi[part]=[];
    for(let i=0;i<Q_PER_SECTION;i++){
      const qnum = pi*Q_PER_SECTION + i + 1;
      // English realistic-looking MCQs (simple)
      bank.english[part].push({
        id:`E-${part}-${i+1}`,
        text: `Question ${i+1} (Part ${part}) — This is a sample English MCQ number ${qnum}. Choose the best option.`,
        options: [
          `Option A for question ${qnum}`,
          `Option B for question ${qnum}`,
          `Option C for question ${qnum}`,
          `Option D for question ${qnum}`
        ]
      });
      // Hindi counterpart
      bank.hindi[part].push({
        id:`H-${part}-${i+1}`,
        text: `प्रश्न ${i+1} (भाग ${part}) — यह डमी हिन्दी प्रश्न संख्या ${qnum} है। सही विकल्प चुनें।`,
        options: [
          `विकल्प A - प्रश्न ${qnum}`,
          `विकल्प B - प्रश्न ${qnum}`,
          `विकल्प C - प्रश्न ${qnum}`,
          `विकल्प D - प्रश्न ${qnum}`
        ]
      });
    }
  });
  return bank;
}

/* ======== State load/save ======== */
let bank = loadJSON(KEY_BANK, defaultBank());
let savedState = loadJSON(KEY_STATE, null);
let attempts = loadJSON(KEY_ATTEMPTS, []);
if(!savedState){
  savedState = { // will hold per-language answers/status/timeLeft meta etc.
    meta:{},
    english: {},
    hindi: {}
  };
}
/* initialize answers structure if missing */
function ensureLangState(lang){
  if(!savedState[lang]) savedState[lang] = {};
  SECTIONS.forEach(p=>{
    if(!Array.isArray(savedState[lang][p])) savedState[lang][p] = Array(Q_PER_SECTION).fill(null);
    if(!Array.isArray(savedState[lang][p+'_status'])) savedState[lang][p+'_status'] = Array(Q_PER_SECTION).fill('notVisited');
    if(!Array.isArray(savedState[lang][p+'_time'])) savedState[lang][p+'_time'] = Array(Q_PER_SECTION).fill(0);
    while(savedState[lang][p].length < Q_PER_SECTION) savedState[lang][p].push(null);
    while(savedState[lang][p+'_status'].length < Q_PER_SECTION) savedState[lang][p+'_status'].push('notVisited');
    while(savedState[lang][p+'_time'].length < Q_PER_SECTION) savedState[lang][p+'_time'].push(0);
    if(p==='A' && savedState[lang][p+'_status'].indexOf('current')===-1) savedState[lang][p+'_status'][0]='current';
  });
  saveJSON(KEY_STATE, savedState);
}
ensureLangState('english'); ensureLangState('hindi');

/* ======== UI refs ======== */
const continueBtn = $('continueBtn'), rollInput = $('rollInput'), nameInput = $('nameInput');
const page1 = $('page1'), page2 = $('page2'), page3 = $('page3');
const startBtn = $('startBtn'), backBtn = $('backBtn'), langSelect = $('langSelect');
const candidateInfo = $('candidateInfo');
const topTimer = $('topTimer'), globalTimer = $('globalTimer');
const qGrid = $('qGrid'), qArea = $('qArea'), qLabel = $('qLabel');
const partButtons = document.querySelectorAll('.part-btn'), curPart = $('curPart');
const ansCountEl = $('ansCount'), notAnsCountEl = $('notAnsCount'), sectionTimeEl = $('sectionTime');
const saveBtn = $('saveBtn'), markBtn = $('markBtn'), clearBtn = $('clearBtn');
const submitBtn = $('submitBtn'), reviewBtn = $('reviewBtn'), darkToggle = $('darkToggle');
const watermark = $('watermark');
const adminBtn = $('adminBtn'), adminQuick = $('adminQuick');
const adminPanel = $('adminPanel'), closeAdmin = $('closeAdmin');
const adminLang = $('adminLang'), adminPart = $('adminPart'), adminList = $('adminList');
const adminSearch = $('adminSearch'), adminQText = $('adminQText'), adminOptions = $('adminOptions');
const adminAdd = $('adminAdd'), adminUpdate = $('adminUpdate'), adminReset = $('adminReset');
const exportBankBtn = $('exportBank'), importBankBtn = $('importBank'), importFile = $('importFile');
const viewAttempts = $('viewAttempts'), exportAttempts = $('exportAttempts');
const setPassBtn = $('setPassBtn'), newPass = $('newPass');
const modal = $('modal'), modalBox = $('modalBox');

/* ======== App runtime state ======== */
let state = {
  roll:'', name:'', lang:'english', part:'A', qIndex:0,
  timeLeft: START_SECONDS, timerInterval:null,
  qStartTs: null, filter:'all',
  submitted:false
};

/* ======== Helpers ======== */
function showPage(num){
  page1.classList.remove('active'); page2.classList.remove('active'); page3.classList.remove('active');
  if(num===1) page1.classList.add('active');
  if(num===2) page2.classList.add('active');
  if(num===3) page3.classList.add('active');
}
function formatTime(s){ const hh = String(Math.floor(s/3600)).padStart(2,'0'); const mm = String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss = String(s%60).padStart(2,'0'); return `${hh}:${mm}:${ss}`; }
function saveState(){ savedState.meta.timeLeft = state.timeLeft; saveJSON(KEY_STATE, savedState); }
function showModal(html){ modalBox.innerHTML = html; modal.style.display='flex'; }
function hideModal(){ modal.style.display='none'; modalBox.innerHTML=''; }

/* ======== Event wiring ======== */
continueBtn.addEventListener('click', ()=> {
  const roll = rollInput.value.trim(), name = nameInput.value.trim();
  if(!roll || !name){ alert('Please enter both Roll number and Candidate name.'); return; }
  state.roll = roll; state.name = name;
  showPage(2);
});
backBtn.addEventListener('click', ()=> showPage(1));
startBtn.addEventListener('click', ()=> {
  state.lang = langSelect.value==='hindi' ? 'hindi' : 'english';
  prepareTest();
  showPage(3);
});
darkToggle.addEventListener('click', ()=> document.body.classList.toggle('dark'));
adminBtn.addEventListener('click', ()=> promptAdmin());
adminQuick.addEventListener('click', ()=> promptAdmin());
closeAdmin.addEventListener('click', ()=> adminPanel.style.display='none');
exportBankBtn.addEventListener('click', ()=> downloadFile(JSON.stringify(bank,null,2),'ssc_bank.json','application/json'));
importBankBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const parsed=JSON.parse(fr.result); if(parsed.english && parsed.hindi){ if(confirm('Replace bank with imported?')){ bank=parsed; saveJSON(KEY_BANK,bank); alert('Imported. Refreshing.'); location.reload(); } } else alert('Invalid bank file'); }catch(err){ alert('Invalid JSON'); } }; fr.readAsText(f); });

viewAttempts.addEventListener('click', ()=> showAttempts());
exportAttempts.addEventListener('click', ()=> exportAttemptsCSV());
setPassBtn.addEventListener('click', ()=> {
  const p = newPass.value.trim(); if(!p){ alert('Enter new pass'); return; } localStorage.setItem('ssc_admin_pass_final', p); alert('Pass updated'); newPass.value=''; 
});

/* ======== Prepare test (load bank + state) ======== */
function prepareTest(){
  ensureLangState(state.lang);
  saveJSON(KEY_BANK, bank);
  // set watermark, candidate info
  watermark.textContent = `Roll: ${state.roll}`;
  watermark.style.display='block';
  candidateInfo.textContent = `Roll: ${state.roll} | Name: ${state.name} | Lang: ${state.lang}`;
  // build working questions array from bank with selected/status/time
  state.questions = JSON.parse(JSON.stringify(bank[state.lang]));
  // ensure savedState arrays exist
  ensureLangState(state.lang);
  // load selections/status/time into state.questions
  SECTIONS.forEach(p=> state.questions[p].forEach((q, idx)=> {
    q.selected = savedState[state.lang][p][idx];
    q.status = savedState[state.lang][p+'_status'][idx];
    q.timeSpent = savedState[state.lang][p+'_time'][idx] || 0;
  }));
  state.part='A';
  let cur = savedState[state.lang]['A_status'].indexOf('current');
  if(cur===-1) cur=0;
  state.qIndex=cur;
  // set timers
  state.timeLeft = savedState.meta && typeof savedState.meta.timeLeft==='number' ? savedState.meta.timeLeft : START_SECONDS;
  renderTimer();
  renderParts();
  renderGrid();
  renderQuestion();
  startGlobalTimer();
  startQuestionTimer();
}

/* ======== Render parts & grid ======== */
function renderParts(){
  document.querySelectorAll('.part-btn').forEach(b=>{ b.classList.toggle('active', b.dataset.part===state.part); b.onclick=()=> switchPart(b.dataset.part); });
  curPart.textContent = state.part;
}
function switchPart(p){
  stopQuestionTimer();
  // finalize previous current
  const prev = state.questions[state.part][state.qIndex];
  if(prev && prev.status==='current'){ prev.status = prev.selected!==null ? 'answered' : 'notVisited'; savedState[state.lang][state.part+'_status'][state.qIndex]=prev.status; savedState[state.lang][state.part][state.qIndex]=prev.selected; savedState[state.lang][state.part+'_time'][state.qIndex]=prev.timeSpent||0; saveJSON(KEY_STATE,savedState); }
  state.part = p;
  // ensure current exists
  let curIdx = savedState[state.lang][p+'_status'].indexOf('current');
  if(curIdx===-1){ curIdx = savedState[state.lang][p+'_status'].indexOf('notVisited'); if(curIdx===-1) curIdx=0; savedState[state.lang][p+'_status'][curIdx]='current'; saveJSON(KEY_STATE,savedState); }
  state.qIndex = curIdx;
  // reload selections/status/time into state.questions
  state.questions[p].forEach((q, idx)=>{ q.selected = savedState[state.lang][p][idx]; q.status = savedState[state.lang][p+'_status'][idx]; q.timeSpent = savedState[state.lang][p+'_time'][idx]||0; });
  renderParts(); renderGrid(); renderQuestion(); startQuestionTimer();
}
function renderGrid(){
  qGrid.innerHTML=''; 
  state.questions[state.part].forEach((q, idx)=>{
    const btn = document.createElement('button'); btn.className='qbtn';
    const st = q.status || 'notVisited';
    if(st==='current') btn.classList.add('q-current');
    else if(st==='answered') btn.classList.add('q-answered');
    else if(st==='review') btn.classList.add('q-review');
    else btn.classList.add('q-notvisited');
    btn.textContent = idx+1; btn.title=`Question ${idx+1}`; btn.onclick=()=> goToQuestion(idx);
    // filtering
    if(state.filter==='answered' && q.selected===null) btn.style.display='none';
    if(state.filter==='notAnswered' && q.selected!==null) btn.style.display='none';
    if(state.filter==='review' && q.status!=='review') btn.style.display='none';
    qGrid.appendChild(btn);
  });
}

/* palette filter buttons */
document.querySelectorAll('.palette-controls button').forEach(b=>{
  b.addEventListener('click', ()=> { state.filter = b.dataset.filter; renderGrid(); });
});

/* ======== Question render & actions ======== */
function renderQuestion(){
  const q = state.questions[state.part][state.qIndex];
  qLabel.textContent = `${state.part}-${state.qIndex+1}`;
  let html = `<div class="qtext">${escapeHtml(q.text)}</div><div class="options">`;
  q.options.forEach((opt,i)=>{ const checked = q.selected!==null && q.selected===i ? 'checked' : ''; html+= `<label class="option"><input type="radio" name="opt" value="${i}" ${checked}> <span>${escapeHtml(opt)}</span></label>`; });
  html += `</div><div style="margin-top:8px;color:#666;font-size:13px">Time on this question: <span id="qTime">${q.timeSpent||0}</span> sec</div>`;
  qArea.innerHTML = html;
  qArea.querySelectorAll('input[name="opt"]').forEach(inp=> inp.onchange = (e)=> { const val = parseInt(e.target.value); q.selected = val; q.status='answered'; savedState[state.lang][state.part][state.qIndex]=val; savedState[state.lang][state.part+'_status'][state.qIndex]='answered'; saveJSON(KEY_STATE,savedState); renderGrid(); updateCounts(); });
  updateCounts();
}
function goToQuestion(idx){
  stopQuestionTimer();
  const prev = state.questions[state.part][state.qIndex];
  if(prev && prev.status==='current'){ prev.status = prev.selected!==null ? 'answered' : 'notVisited'; savedState[state.lang][state.part+'_status'][state.qIndex]=prev.status; savedState[state.lang][state.part][state.qIndex]=prev.selected; savedState[state.lang][state.part+'_time'][state.qIndex]=prev.timeSpent||0; saveJSON(KEY_STATE,savedState); }
  state.qIndex = idx;
  const q = state.questions[state.part][state.qIndex];
  q.status = q.status || 'current'; savedState[state.lang][state.part+'_status'][state.qIndex]='current'; saveJSON(KEY_STATE,savedState);
  renderGrid(); renderQuestion(); startQuestionTimer();
}
saveBtn.addEventListener('click', ()=> { stopQuestionTimer(); const q=state.questions[state.part][state.qIndex]; q.status = q.selected!==null ? 'answered' : 'notVisited'; savedState[state.lang][state.part][state.qIndex]=q.selected; savedState[state.lang][state.part+'_status'][state.qIndex]=q.status; savedState[state.lang][state.part+'_time'][state.qIndex]=q.timeSpent||0; saveJSON(KEY_STATE,savedState); if(state.qIndex < Q_PER_SECTION-1) state.qIndex++; else state.qIndex = 0; const next = state.questions[state.part][state.qIndex]; if(next.status==='notVisited'){ next.status='current'; savedState[state.lang][state.part+'_status'][state.qIndex]='current'; saveJSON(KEY_STATE,savedState);} renderGrid(); renderQuestion(); startQuestionTimer();});
markBtn.addEventListener('click', ()=> { stopQuestionTimer(); const q=state.questions[state.part][state.qIndex]; q.status='review'; savedState[state.lang][state.part+'_status'][state.qIndex]='review'; savedState[state.lang][state.part][state.qIndex]=q.selected; savedState[state.lang][state.part+'_time'][state.qIndex]=q.timeSpent||0; saveJSON(KEY_STATE,savedState); if(state.qIndex < Q_PER_SECTION-1) state.qIndex++; else state.qIndex=0; const next=state.questions[state.part][state.qIndex]; if(next.status==='notVisited'){ next.status='current'; savedState[state.lang][state.part+'_status'][state.qIndex]='current'; saveJSON(KEY_STATE,savedState);} renderGrid(); renderQuestion(); startQuestionTimer();});
clearBtn.addEventListener('click', ()=> { const q=state.questions[state.part][state.qIndex]; q.selected=null; q.status='notVisited'; savedState[state.lang][state.part][state.qIndex]=null; savedState[state.lang][state.part+'_status'][state.qIndex]='notVisited'; savedState[state.lang][state.part+'_time'][state.qIndex]=q.timeSpent||0; saveJSON(KEY_STATE,savedState); renderGrid(); renderQuestion(); });

function updateCounts(){ const arr = state.questions[state.part]; const answered = arr.filter(q=> q.selected!==null).length; ansCountEl.textContent = answered; notAnsCountEl.textContent = arr.length - answered; sectionTimeEl.textContent = arr.reduce((s,q)=> s + (q.timeSpent||0),0); }

/* ======== Timer logic ======== */
function startGlobalTimer(){
  if(state.timerInterval) return;
  renderTimer();
  state.timerInterval = setInterval(()=> {
    state.timeLeft--;
    if(state.timeLeft <= 0){ clearInterval(state.timerInterval); state.timeLeft=0; renderTimer(); alert('Time up — auto submitting'); finalizeSubmit(); return; }
    savedState.meta = savedState.meta || {}; savedState.meta.timeLeft = state.timeLeft; saveJSON(KEY_STATE,savedState);
    renderTimer();
  },1000);
}
function renderTimer(){ topTimer.textContent = formatTime(state.timeLeft); globalTimer.textContent = formatTime(state.timeLeft); if(state.timeLeft <= WARNING_SECONDS){ topTimer.classList.add('timer','warn'); globalTimer.classList.add('timer','warn'); } else { topTimer.classList.remove('warn'); globalTimer.classList.remove('warn'); } }

/* ======== Per-question time tracking ======== */
function startQuestionTimer(){ stopQuestionTimer(); state.qStartTs = Date.now(); }
function stopQuestionTimer(){ if(!state.qStartTs) return; const elapsed = Math.floor((Date.now() - state.qStartTs)/1000); state.qStartTs = null; const q = state.questions[state.part][state.qIndex]; q.timeSpent = (q.timeSpent || 0) + elapsed; savedState[state.lang][state.part+'_time'][state.qIndex] = q.timeSpent; saveJSON(KEY_STATE,savedState); const el = $('qTime'); if(el) el.textContent = q.timeSpent; updateCounts(); }

/* ======== Submit & CSV export ======== */
submitBtn.addEventListener('click', ()=> { stopQuestionTimer(); let totals={total:SECTIONS.length*Q_PER_SECTION,answered:0,review:0,notAnswered:0}; SECTIONS.forEach(p=> state.questions[p].forEach(q=>{ if(q.selected!==null) totals.answered++; else totals.notAnswered++; if(q.status==='review') totals.review++; })); if(!confirm(`Submit now?\nAnswered: ${totals.answered}\nMarked: ${totals.review}\nNot answered: ${totals.notAnswered}`)) return; finalizeSubmit(); });

function finalizeSubmit(){
  clearInterval(state.timerInterval); stopQuestionTimer();
  // lock UI
  document.querySelectorAll('button').forEach(b=> b.disabled=true);
  // record attempt
  const attempt = { roll: state.roll, name: state.name, lang: state.lang, date: new Date().toISOString(), snapshot: state.questions, remaining: state.timeLeft };
  attempts.push(attempt); saveJSON(KEY_ATTEMPTS, attempts);
  // CSV
  const header = ['Roll','Name','Lang','Part','QNo','QID','Question','SelectedIndex','SelectedText','Status','TimeSpent'];
  const rows = [header.join(',')];
  SECTIONS.forEach(p=> state.questions[p].forEach((q, idx)=> {
    const selIdx = q.selected!==null ? q.selected : '';
    const selText = q.selected!==null ? q.options[q.selected] : '';
    const status = q.status || savedState[state.lang][p+'_status'][idx] || 'notVisited';
    const timeSpent = q.timeSpent || savedState[state.lang][p+'_time'][idx] || 0;
    const safe = s => `"${String(s).replace(/"/g,'""')}"`;
    rows.push([safe(state.roll), safe(state.name), safe(state.lang), p, idx+1, safe(q.id||''), safe(q.text), selIdx, safe(selText), safe(status), timeSpent].join(','));
  }));
  downloadFile(rows.join('\n'), `ssc_${state.roll}_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`, 'text/csv');
  qArea.innerHTML = `<div style="padding:18px"><h3>Submitted</h3><p>Answers exported and attempt saved locally.</p></div>`;
}

/* ======== Review summary modal ======== */
reviewBtn.addEventListener('click', ()=> {
  stopQuestionTimer();
  let html = '<h3>Review Summary</h3><div style="max-height:500px;overflow:auto"><table style="width:100%"><tr><th>Q</th><th>Status</th><th>Selected</th></tr>';
  SECTIONS.forEach(p=> {
    html += `<tr><td colspan="3" style="background:#f4f7fb;font-weight:700">PART ${p}</td></tr>`;
    state.questions[p].forEach((q,i)=> {
      const status = q.status || 'notVisited'; const sel = q.selected!==null ? q.options[q.selected] : '';
      html += `<tr><td style="padding:6px;border-bottom:1px solid #eee">${p}-${i+1}</td><td style="padding:6px;border-bottom:1px solid #eee">${status}</td><td style="padding:6px;border-bottom:1px solid #eee">${escapeHtml(sel)}</td></tr>`;
    });
  });
  html += '</table></div><div style="text-align:right;margin-top:8px"><button id="closeRev" class="btn secondary">Close</button></div>';
  showModal(html);
  $('closeRev').onclick = ()=> { hideModal(); startQuestionTimer(); };
});

/* ======== Admin prompt & functions ======== */
function promptAdmin(){
  const p = prompt('Enter admin password:');
  if(p===null) return;
  const stored = localStorage.getItem('ssc_admin_pass_final') || ADMIN_PASS;
  if(p === stored){ openAdmin(); } else { alert('Incorrect pass'); }
}
function openAdmin(){ adminPanel.style.display='block'; refreshAdminList(); }
function refreshAdminList(){
  adminList.innerHTML = '';
  const lang = adminLang.value, part = adminPart.value;
  const list = bank[lang][part];
  const search = adminSearch.value.trim().toLowerCase();
  list.forEach((q,idx)=>{
    const combined = (q.text + ' ' + q.options.join(' ')).toLowerCase();
    if(search && !combined.includes(search)) return;
    const el = document.createElement('div'); el.className='admin-list-item'; el.draggable=true; el.dataset.idx=idx;
    el.innerHTML = `<div style="font-weight:700">${idx+1}. ${escapeHtml(q.text)}</div><div style="font-size:13px;margin-top:6px">${q.options.map((o,i)=>`<div>${String.fromCharCode(65+i)}. ${escapeHtml(o)}</div>`).join('')}</div><div style="margin-top:6px"><button data-idx="${idx}" class="editQ btn secondary">Edit</button> <button data-idx="${idx}" class="delQ btn" style="background:var(--danger)">Delete</button></div>`;
    adminList.appendChild(el);
  });
  adminList.querySelectorAll('.editQ').forEach(b=> b.onclick = e=> { const idx=parseInt(e.target.dataset.idx); const q = bank[adminLang.value][adminPart.value][idx]; adminQText.value=q.text; adminOptions.value=q.options.join('\n'); adminAdd.dataset.edit=idx; adminUpdate.dataset.edit=idx; });
  adminList.querySelectorAll('.delQ').forEach(b=> b.onclick = e=> { const idx=parseInt(e.target.dataset.idx); if(confirm('Delete?')){ bank[adminLang.value][adminPart.value].splice(idx,1); saveJSON(KEY_BANK, bank); refreshAdminList(); } });
  enableDrag(adminList, adminLang.value, adminPart.value);
}
adminLang.onchange = refreshAdminList; adminPart.onchange = refreshAdminList; adminSearch.oninput = refreshAdminList;
adminAdd.addEventListener('click', ()=> {
  const lang = adminLang.value, part = adminPart.value;
  const text = adminQText.value.trim(); const opts = adminOptions.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(!text || opts.length<2){ alert('Enter question & at least 2 options'); return; }
  bank[lang][part].push({ id:`${lang[0].toUpperCase()}-${part}-${bank[lang][part].length+1}`, text, options: opts });
  saveJSON(KEY_BANK, bank); adminQText.value=''; adminOptions.value=''; refreshAdminList();
});
adminUpdate.addEventListener('click', ()=> {
  const idx = adminUpdate.dataset.edit ? parseInt(adminUpdate.dataset.edit) : null;
  if(idx===null){ alert('Choose item to update'); return; }
  const lang = adminLang.value, part=adminPart.value; const text = adminQText.value.trim(); const opts = adminOptions.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(!text || opts.length<2){ alert('Enter question & at least 2 options'); return; }
  bank[lang][part][idx].text = text; bank[lang][part][idx].options = opts; saveJSON(KEY_BANK, bank); adminQText.value=''; adminOptions.value=''; delete adminUpdate.dataset.edit; refreshAdminList();
});
adminReset.addEventListener('click', ()=> { if(confirm('Reset to default bank?')){ bank = defaultBank(); saveJSON(KEY_BANK,bank); alert('Reset. Reloading.'); location.reload(); } });
exportBankBtn.addEventListener('click', ()=> downloadFile(JSON.stringify(bank,null,2),'ssc_bank.json','application/json'));

/* drag reorder */
function enableDrag(container, lang, part){
  let dragEl = null;
  container.querySelectorAll('.admin-list-item').forEach(item=>{
    item.addEventListener('dragstart', e=>{ dragEl = item; item.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; });
    item.addEventListener('dragend', ()=>{ if(dragEl) dragEl.classList.remove('dragging'); });
    item.addEventListener('dragover', e=>{ e.preventDefault(); const target = e.currentTarget; if(target===dragEl) return; const rect = target.getBoundingClientRect(); const mid = rect.top + rect.height/2; if(e.clientY < mid) target.parentNode.insertBefore(dragEl, target); else target.parentNode.insertBefore(dragEl, target.nextSibling); });
    item.addEventListener('drop', e=>{ e.preventDefault(); const arr = Array.from(container.querySelectorAll('.admin-list-item')).map(el=> el.querySelector('div').textContent.replace(/^\d+\.\s*/,'') ); // best-effort reorder by matching text
      const orig = bank[lang][part].slice(); const newArr=[]; arr.forEach(txt=>{ const i=orig.findIndex(x=>x && x.text===txt); if(i!==-1){ newArr.push(orig[i]); orig[i]=null; } }); if(newArr.length===bank[lang][part].length){ bank[lang][part]=newArr; saveJSON(KEY_BANK, bank); refreshAdminList(); } else refreshAdminList();});
  });
}

/* ======== Attempts view/export ======== */
function showAttempts(){
  const arr = loadJSON(KEY_ATTEMPTS, []);
  if(!arr.length){ alert('No attempts yet'); return; }
  let html = '<h3>Past Attempts</h3><div style="max-height:400px;overflow:auto"><table style="width:100%"><tr><th>Date</th><th>Roll</th><th>Name</th><th>Lang</th><th>Answered</th></tr>';
  arr.forEach(a=>{
    let answered=0; SECTIONS.forEach(p=> a.snapshot[p].forEach(q=> { if(q.selected!==null) answered++; }));
    html += `<tr><td>${a.date}</td><td>${escapeHtml(a.roll)}</td><td>${escapeHtml(a.name)}</td><td>${escapeHtml(a.lang)}</td><td>${answered}</td></tr>`;
  });
  html += '</table></div><div style="text-align:right;margin-top:8px"><button id="closeAtt" class="btn secondary">Close</button></div>';
  showModal(html); $('closeAtt').onclick = ()=> hideModal();
}
function exportAttemptsCSV(){ const arr = loadJSON(KEY_ATTEMPTS,[]); if(!arr.length){ alert('No attempts'); return; } const rows=[['Date','Roll','Name','Lang','Answered'].join(',')]; arr.forEach(a=>{ let answered=0; SECTIONS.forEach(p=> a.snapshot[p].forEach(q=> { if(q.selected!==null) answered++; })); rows.push([`"${a.date}"`,`"${a.roll}"`,`"${a.name}"`,`"${a.lang}"`,answered].join(',')); }); downloadFile(rows.join('\n'),'attempts.csv','text/csv'); }

/* ======== Timer & focus/zoom prevention ======== */
document.addEventListener('visibilitychange', ()=> { if(document.hidden && state.page===3) alert('You left the test tab/window. This is recorded.'); });
window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey) && (e.key==='+'||e.key==='='||e.key==='-'||e.key==='0')){ e.preventDefault(); if(state.page===3) alert('Zoom disabled during test'); }});
document.addEventListener('contextmenu',(e)=>{ if(state.page===3) e.preventDefault(); });
document.addEventListener('copy',(e)=>{ if(state.page===3) e.preventDefault(); });

/* ======== Init UI ======== */
(function init(){
  // wire admin quick btn
  $('adminQuick').onclick = ()=> promptAdmin();
  // set initial parts
  document.querySelectorAll('.part-btn').forEach((b,i)=> b.dataset.part = SECTIONS[i]);
  // ensure bank saved
  saveJSON(KEY_BANK, bank);
})();
</script>
</body>
</html>